<div class="main-content">
  <div class="container-fluid">
    <!-- Page Header -->
    <div class="row">
      <div class="col-12">
        <div class="page-header">
          <h3 class="page-title">
            <i class="material-icons">error_outline</i>
            Shubhali Kirimlar Ro'yxati
          </h3>
          <button mat-raised-button color="accent" (click)="downloadExcel()" class="add-btn"
            [disabled]="incomesList.length === 0">
            <i class="material-icons">download</i>
            Excel Yuklab Olish
          </button>
        </div>
      </div>
    </div>

    <!-- Main Card -->
    <div class="row">
      <div class="col-12">
        <div class="card income-card" id="listcard">
          <!-- Filters Section -->
          <div class="card-header">
            <div class="filters-container">
              <!-- Quick Filters -->
              <div class="quick-filters">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Izoh bo'yicha qidirish</mat-label>
                  <input matInput type="text" placeholder="Qidirish..." [value]="filters.comment"
                    (input)="applyFilter('comment', $event.target.value)" />
                  <mat-icon matPrefix>search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Kategoriya</mat-label>
                  <mat-select [value]="filters.category_id" (selectionChange)="applyFilter('category', $event.value)">
                    <mat-option [value]="''">Barchasi</mat-option>
                    <mat-option *ngFor="let cat of incomeCats" [value]="cat.id">
                      {{ cat.name }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matPrefix>category</mat-icon>
                </mat-form-field>

                <button mat-stroked-button (click)="toggleAdvancedFilters()" class="toggle-filters-btn">
                  <mat-icon>{{ showAdvancedFilters ? 'expand_less' : 'expand_more' }}</mat-icon>
                  {{ showAdvancedFilters ? 'Kamroq' : 'Ko\'proq' }} Filtrlar
                </button>

                <button mat-stroked-button (click)="clearFilters()" *ngIf="hasActiveFilters()"
                  class="clear-filters-btn">
                  <mat-icon>clear</mat-icon>
                  Tozalash
                </button>
              </div>

              <!-- Advanced Filters (Collapsible) -->
              <div class="advanced-filters" *ngIf="showAdvancedFilters">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Admin ID</mat-label>
                  <input matInput type="text" [value]="filters.staff_id"
                    (input)="applyFilter('staff', $event.target.value)" />
                  <mat-icon matPrefix>badge</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Boshlanish sanasi</mat-label>
                  <input matInput [matDatepicker]="startPicker" [value]="filters.startDate"
                    (dateChange)="applyFilter('startDate', $event.value)" />
                  <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                  <mat-datepicker #startPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Tugash sanasi</mat-label>
                  <input matInput [matDatepicker]="endPicker" [value]="filters.endDate"
                    (dateChange)="applyFilter('endDate', $event.value)" />
                  <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                  <mat-datepicker #endPicker></mat-datepicker>
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- Card Body -->
          <div class="card-body">
            <!-- Loading State -->
            <div class="loading-container" *ngIf="isLoading">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Yuklanmoqda...</p>
            </div>

            <!-- Error State -->
            <div class="error-container" *ngIf="errorMessage && !isLoading">
              <mat-icon color="warn">error_outline</mat-icon>
              <p>{{ errorMessage }}</p>
              <button mat-raised-button color="primary" (click)="loadIncomes()">
                Qayta urinish
              </button>
            </div>

            <!-- Empty State -->
            <div class="empty-container" *ngIf="!isLoading && !errorMessage && incomesList.length === 0">
              <mat-icon>inbox</mat-icon>
              <h3>Shubhali kirimlar mavjud emas</h3>
              <p>Barcha kirimlar tekshirilgan</p>
            </div>

            <!-- Table -->
            <div class="table-container" *ngIf="!isLoading && !errorMessage && incomesList.length > 0">
              <table mat-table [dataSource]="incomesList" matSort (matSortChange)="sortData($event)"
                class="incomes-table">

                <!-- Index Column -->
                <ng-container matColumnDef="index">
                  <th mat-header-cell *matHeaderCellDef class="index-col">№</th>
                  <td mat-cell *matCellDef="let row; let i = index" class="index-col">
                    {{ (currentPage * pageSize) + i + 1 }}
                  </td>
                </ng-container>

                <!-- UZS Cash Column -->
                <ng-container matColumnDef="uzs_cash">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>So'mda</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="currency-value" *ngIf="row.uzs_cash && row.uzs_cash > 0">
                      {{ row.uzs_cash | number:'1.0-0' }} <small>so'm</small>
                    </span>
                    <span class="empty-value" *ngIf="!row.uzs_cash || row.uzs_cash == 0">—</span>
                  </td>
                </ng-container>

                <!-- USD Cash Column -->
                <ng-container matColumnDef="usd_cash">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Dollarda</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="currency-value" *ngIf="row.usd_cash && row.usd_cash > 0">
                      ${{ row.usd_cash | number:'1.0-0' }}
                    </span>
                    <span class="empty-value" *ngIf="!row.usd_cash || row.usd_cash == 0">—</span>
                  </td>
                </ng-container>

                <!-- Card Column -->
                <ng-container matColumnDef="card">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Kartadan</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="currency-value" *ngIf="row.card && row.card > 0">
                      {{ row.card | number:'1.0-0' }} <small>so'm</small>
                    </span>
                    <span class="empty-value" *ngIf="!row.card || row.card == 0">—</span>
                  </td>
                </ng-container>

                <!-- Account Column -->
                <ng-container matColumnDef="account">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Hisobdan</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="currency-value" *ngIf="row.account && row.account > 0">
                      {{ row.account | number:'1.0-0' }} <small>so'm</small>
                    </span>
                    <span class="empty-value" *ngIf="!row.account || row.account == 0">—</span>
                  </td>
                </ng-container>

                <!-- Admin ID Column -->
                <ng-container matColumnDef="admin_id">
                  <th mat-header-cell *matHeaderCellDef>Admin ID</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="user-id-badge" *ngIf="row.admin_id">
                      {{ row.admin_id }}
                    </span>
                    <span class="empty-value" *ngIf="!row.admin_id">—</span>
                  </td>
                </ng-container>

                <!-- User ID Column -->
                <ng-container matColumnDef="userId">
                  <th mat-header-cell *matHeaderCellDef>Mijoz ID</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="user-id-badge" *ngIf="row.userId">
                      {{ row.userId }}
                    </span>
                    <span class="empty-value" *ngIf="!row.userId">—</span>
                  </td>
                </ng-container>

                <!-- Part Number Column -->
                <ng-container matColumnDef="part_num">
                  <th mat-header-cell *matHeaderCellDef>Partiya</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="part-num-badge" *ngIf="row.part_num">
                      {{ row.part_num }}
                    </span>
                    <span class="empty-value" *ngIf="!row.part_num">—</span>
                  </td>
                </ng-container>

                <!-- Comment Column -->
                <ng-container matColumnDef="comment">
                  <th mat-header-cell *matHeaderCellDef>Izoh</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="comment-text" [title]="row.comment">
                      {{ row.comment || '—' }}
                    </span>
                  </td>
                </ng-container>

                <!-- Category Column -->
                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>Kategoriya</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="category-badge" *ngIf="row.category">
                      {{ row.category.name }}
                    </span>
                    <span class="empty-value" *ngIf="!row.category">—</span>
                  </td>
                </ng-container>

                <!-- Date Column -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Sana</th>
                  <td mat-cell *matCellDef="let row">
                    {{ row.date | date:'dd.MM.yyyy HH:mm' }}
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef class="actions-col">Amallar</th>
                  <td mat-cell *matCellDef="let row" class="actions-col">
                    <button mat-icon-button color="primary" (click)="succCheck(row)" matTooltip="Muvaffaqiyatli"
                      [class.active-action]="row.id === selectedIncomeId">
                      <mat-icon>check_circle</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="failedCheck(row)" matTooltip="Muvaffaqiyatsiz"
                      [class.active-action]="row.id === selectedIncomeId">
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <!-- Table Header and Rows -->
                <tr mat-header-row
                  *matHeaderRowDef="['index', 'uzs_cash', 'usd_cash', 'card', 'account', 'admin_id', 'userId', 'part_num', 'comment', 'category', 'date', 'actions']">
                </tr>
                <tr mat-row
                  *matRowDef="let row; columns: ['index', 'uzs_cash', 'usd_cash', 'card', 'account', 'admin_id', 'userId', 'part_num', 'comment', 'category', 'date', 'actions']"
                  [class.row-selected]="row.id === selectedIncomeId">
                </tr>
              </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container" *ngIf="!isLoading && totalPages > 1">
              <div class="pagination-info">
                Jami: <strong>{{ totalItems }}</strong> ta shubhali kirim
              </div>

              <mat-paginator [length]="totalItems" [pageSize]="pageSize" [pageIndex]="currentPage" [hidePageSize]="true"
                (page)="goToPage($event.pageIndex)">
              </mat-paginator>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>